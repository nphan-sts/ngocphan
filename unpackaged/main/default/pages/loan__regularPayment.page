<apex:page lightningStylesheets="true" id="loanRegularPaymentPage"
    standardController="loan__Loan_Payment_Transaction__c"
    extensions="loan.LoanRegularPaymentTxnController"
    sidebar="{!IF($CurrentPage.Parameters.modal == 'true', false, true)}"
    title="Record A New Payment">
<apex:include pageName="clcommon__mintTheme"/>

    <apex:stylesheet value="{!IF($CurrentPage.Parameters.modal == 'true', $Resource.loan__modalheaderStyle,'')}" />
    <script
        src="{!URLFOR($Resource.jQueryFiles, 'js/jquery-1.8.3.min.js')}" />
    <script type="text/javascript"
        src="{!URLFOR($Resource.MFICustomWidgets, 'js/MFIWidgets.js')}"></script>
    <link rel="stylesheet"
        href="{!URLFOR($Resource.MFICustomWidgets, 'css/MFIWidgets.css')}"
        type="text/css"></link>
    <script
        src="{!URLFOR($Resource.jQueryFiles, 'js/jquery-1.8.3.min.js')}" />
    <script src="{!URLFOR($Resource.helperclose)}" />

    <script>
        j$ = jQuery.noConflict();
        function setFocusOnLoad() {}
    </script>
    <apex:sectionHeader title="Record a payment" id="loanPaymentSection" />
    <c:HighlightsPanel labels="Principal, Interest, Fees, Excess, Status"
        id="hp"
        rendered="{!IF(OR(Loan_Payment_Transaction__c.Manual_Payment__c, 
                                                 Loan_Payment_Transaction__c.Cleared__c, 
                                                 Loan_Payment_Transaction__c.Rejected__c), true, false)}"
        value1="{!loan__Loan_Payment_Transaction__c.loan__Principal__c}"
        value2="{!loan__Loan_Payment_Transaction__c.loan__Interest__c}"
        value3="{!loan__Loan_Payment_Transaction__c.loan__Fees__c}"
        value4="{!loan__Loan_Payment_Transaction__c.loan__Excess__c}"
        value5="{!(IF(Loan_Payment_Transaction__c.Reversed__c, 'Reversed', 
                                            IF(Loan_Payment_Transaction__c.Rejected__c, 'Rejected', 
                                                IF(Loan_Payment_Transaction__c.Cleared__c, 'Cleared', 'New'))))}"
        class5="{!IF(loan__Loan_Payment_Transaction__c.loan__Cleared__c, 'green', 'red')}" />
    <apex:form id="frmMain">
        <apex:pageBlock mode="edit" id="createLoanPaymentTxn">
            <apex:inlineEditSupport disabled="{!(OR(loan__Loan_Payment_Transaction__c.loan__Cleared__c, loan__Loan_Payment_Transaction__c.loan__Rejected__c))}" />
            <apex:pageMessages />
            <apex:pageBlockButtons id="blkButtons" location="both">
                <apex:actionStatus onstart="disableButtons()" id="validateStatus" />
                <!--<apex:actionStatus id="mySaveStatus1">
                     <apex:facet name="stop">
                         <apex:commandButton value="New Validate" action="{!validate}" 
                             rerender="createLoanPaymentTxn" status="mySaveStatus1"/>
                     </apex:facet>
                     <apex:facet name="start">
                         <apex:outputPanel >
                               <apex:image value="/img/loading32.gif" style="height: 15px;"/>
                               <apex:commandButton value="Processing..." status="mySaveStatus1" disabled="true"/>
                           </apex:outputPanel>
                       </apex:facet>
                  </apex:actionStatus>-->
                <c:BusyButton name="Validate" busyname="Validating..."
                    actionTo="{!validate}" reRenderTo="createLoanPaymentTxn"
                    disabled="{!(OR(loan__Loan_Payment_Transaction__c.loan__Cleared__c, loan__Loan_Payment_Transaction__c.loan__Rejected__c))}"
                    style="margin-left:100px;" />
                <!--<apex:commandButton value="Validate" 
                      action="{!validate}" 
                      id="vBtn" 
                      status="validateStatus"
                      reRender="createLoanPaymentTxn"
                      disabled="{!(OR(loan__Loan_Payment_Transaction__c.loan__Cleared__c, loan__Loan_Payment_Transaction__c.loan__Rejected__c))}"/>-->
                <c:BusyButton name="Save" busyName="Saving" actionTo="{!save}"
                    id="sBtn" reRenderTo="frmMain"
                    oncomplete="({!closeModal}===true) ? closeIframe('{!loan__Loan_Payment_Transaction__c.loan__Loan_Account__c}') : {};"
                    disabled="{!(OR(loan__Loan_Payment_Transaction__c.loan__Cleared__c, loan__Loan_Payment_Transaction__c.loan__Rejected__c))}" />
                <!--<apex:commandButton value="Save" action="{!save}" id="sBtn"
                      reRender="frmMain" oncomplete="({!closeModal}===true) ? function reload(){window.top.location.href='/' + '{!loan__Loan_Payment_Transaction__c.loan__Loan_Account__c}'; closeIframe();}() : {};"
                      disabled="{!(OR(loan__Loan_Payment_Transaction__c.loan__Cleared__c, loan__Loan_Payment_Transaction__c.loan__Rejected__c))}"/>-->
                <apex:commandButton value="Cancel" action="{!cancel}"
                    onclick="closeIframe()" id="cBtn" />
            </apex:pageBlockButtons>
            <apex:outputpanel styleClass="mint-lightning-wrapper mint-lightning-wrapper-center">
            <apex:pageBlockSection title="Payment Transaction" columns="2">
                <apex:outputField value="{!loan__Loan_Payment_Transaction__c.Name}">
                </apex:outputField>
                <apex:outputField value="{!loan__Loan_Payment_Transaction__c.loan__Loan_Account__c}">
                </apex:outputField>
                <apex:inputField value="{!loan__Loan_Payment_Transaction__c.loan__Manual_Payment__c}"
                    label="Spread Manually"
                    rendered="{!AND(NOT(Loan_Payment_Transaction__c.Manual_Payment__c), 
                                      NOT(OR(Loan_Payment_Transaction__c.Cleared__c, Loan_Payment_Transaction__c.Rejected__c)))}">
                    <apex:actionSupport action="{!setManualPaymentMode}"
                        rerender="spreadId,createLoanPaymentTxn" event="onchange" />                    
                </apex:inputField>
                <apex:outputField value="{!loan__Loan_Payment_Transaction__c.loan__Manual_Payment__c}"
                    rendered="{!OR(Loan_Payment_Transaction__c.Manual_Payment__c, 
                                      OR(Loan_Payment_Transaction__c.Cleared__c, Loan_Payment_Transaction__c.Rejected__c))}" />
                <apex:OutputLabel ></apex:OutputLabel>
                <apex:inputField value="{!loan__Loan_Payment_Transaction__c.loan__Write_Off_Recovery_Payment__c}"
                    label="Write off Recovery"
                    rendered="{!AND(NOT(Loan_Payment_Transaction__c.Write_Off_Recovery_Payment__c), 
                                      NOT(OR(Loan_Payment_Transaction__c.Cleared__c, Loan_Payment_Transaction__c.Rejected__c)))}" />
                
                <apex:outputField value="{!loan__Loan_Payment_Transaction__c.loan__Write_Off_Recovery_Payment__c}"
                    rendered="{!OR(Loan_Payment_Transaction__c.Write_Off_Recovery_Payment__c, 
                                      OR(Loan_Payment_Transaction__c.Cleared__c, Loan_Payment_Transaction__c.Rejected__c))}" />              
                <apex:inputField value="{!loan__Loan_Payment_Transaction__c.loan__Installment_Payment__c}"
                    label="Installment Payment"
                    rendered="{!loanAccount.loan__Product_Type__c == 'Flexible Amz Loan'}" />
                <apex:inputField value="{!loan__Loan_Payment_Transaction__c.loan__Transaction_Date__c}"
                    required="true"
                    rendered="{!NOT(OR(loan__Loan_Payment_Transaction__c.loan__Cleared__c, loan__Loan_Payment_Transaction__c.loan__Rejected__c))}" />
                <apex:outputField value="{!loan__Loan_Payment_Transaction__c.loan__Transaction_Date__c}"
                    rendered="{!(OR(loan__Loan_Payment_Transaction__c.loan__Cleared__c, loan__Loan_Payment_Transaction__c.loan__Rejected__c))}" />
                
                <apex:inputField value="{!loan__Loan_Payment_Transaction__c.loan__Payment_Application_Mode__c}"
                    label="Payment Application Mode"
                    rendered="{!AND(showPaymentAppMode, NOT(OR(loan__Loan_Payment_Transaction__c.loan__Cleared__c, loan__Loan_Payment_Transaction__c.loan__Rejected__c)))}" />
                
                <apex:outputField value="{!loan__Loan_Payment_Transaction__c.loan__Payment_Application_Mode__c}"
                    rendered="{!AND(showPaymentAppMode, OR(loan__Loan_Payment_Transaction__c.loan__Cleared__c, loan__Loan_Payment_Transaction__c.loan__Rejected__c))}" />
                <apex:outputLabel ></apex:outputLabel>
                <apex:outputField value="{!loan__Loan_Payment_Transaction__c.loan__Early_Total_Repayment_of_the_Loan__c}"
                    rendered="{!loan__Loan_Payment_Transaction__c.loan__Early_Total_Repayment_of_the_Loan__c}" />
            </apex:pageBlockSection>
            <apex:pageBlockSection title="Spread" columns="1" id="spreadId">
                <apex:inputField value="{!loan__Loan_Payment_Transaction__c.loan__Payment_Mode__c}"
                    required="true"
                    rendered="{!NOT(OR(loan__Loan_Payment_Transaction__c.loan__Cleared__c, loan__Loan_Payment_Transaction__c.loan__Rejected__c))}" >
                    <apex:actionSupport status="loadExcess" action="{!populateTransactionAmount}" event="onchange"  rerender="spreadId" />
                    <apex:actionStatus id="loadExcess">
                        <apex:facet name="start">
                            <apex:image value="/img/loading32.gif" style="height:15px;" />
                        </apex:facet>
                    </apex:actionStatus>
                </apex:inputField>
                <apex:outputField value="{!loan__Loan_Payment_Transaction__c.loan__Payment_Mode__c}"
                    rendered="{!(OR(loan__Loan_Payment_Transaction__c.loan__Cleared__c, loan__Loan_Payment_Transaction__c.loan__Rejected__c))}" />
                <apex:inputField value="{!loan__Loan_Payment_Transaction__c.loan__Cheque_Number__c}"
                    rendered="{!NOT(OR(loan__Loan_Payment_Transaction__c.loan__Cleared__c, loan__Loan_Payment_Transaction__c.loan__Rejected__c))}" />
                <apex:outputField value="{!loan__Loan_Payment_Transaction__c.loan__Cheque_Number__c}"
                    rendered="{!(OR(loan__Loan_Payment_Transaction__c.loan__Cleared__c, loan__Loan_Payment_Transaction__c.loan__Rejected__c))}" />
                <apex:inputField value="{!loan__Loan_Payment_Transaction__c.loan__Principal__c}"
                    required="true"
                    rendered="{!(AND(Loan_Payment_Transaction__c.Manual_Payment__c,
                                                  NOT(OR(Loan_Payment_Transaction__c.Cleared__c, Loan_Payment_Transaction__c.Rejected__c))))}" >
                    <apex:actionSupport action="{!updateTransactionAmount}" event="onchange" rerender="spreadId"/>
                </apex:inputField>
                <apex:outputField value="{!loan__Loan_Payment_Transaction__c.loan__Principal__c}"
                    rendered="{!AND(Loan_Payment_Transaction__c.Manual_Payment__c, OR(NOT(Loan_Payment_Transaction__c.Manual_Payment__c),
                                                  OR(Loan_Payment_Transaction__c.Cleared__c, Loan_Payment_Transaction__c.Rejected__c)))}" />
                <apex:inputField value="{!loan__Loan_Payment_Transaction__c.loan__Interest__c}"
                    required="true"
                    rendered="{!(AND(Loan_Payment_Transaction__c.Manual_Payment__c, 
                                                  NOT(OR(Loan_Payment_Transaction__c.Cleared__c, Loan_Payment_Transaction__c.Rejected__c))))}" 
                                                  >
                    <apex:actionSupport action="{!updateTransactionAmount}" event="onchange" rerender="spreadId"/>
                </apex:inputField>
                <apex:outputField value="{!loan__Loan_Payment_Transaction__c.loan__Interest__c}"
                    rendered="!AND(Loan_Payment_Transaction__c.Manual_Payment__c, OR(NOT(Loan_Payment_Transaction__c.Manual_Payment__c),
                                                  OR(Loan_Payment_Transaction__c.Cleared__c, Loan_Payment_Transaction__c.Rejected__c)))}" />
                <apex:pageblockSectionItem rendered="{!(AND(Loan_Payment_Transaction__c.Manual_Payment__c, 
                                                  NOT(OR(Loan_Payment_Transaction__c.Cleared__c, Loan_Payment_Transaction__c.Rejected__c))))}">

                    <apex:outputlabel >Fees</apex:outputlabel>
                    <apex:outputPanel >
                        <apex:inputField value="{!loan__Loan_Payment_Transaction__c.loan__Fees__c}"
                            required="true"
                            rendered="{!(AND(Loan_Payment_Transaction__c.Manual_Payment__c, 
                                                      NOT(OR(Loan_Payment_Transaction__c.Cleared__c, Loan_Payment_Transaction__c.Rejected__c))))}" 
                                                      >
                                                      
                              <apex:actionSupport action="{!updateTransactionAmount}" event="onchange" rerender="spreadId"/>
                        </apex:inputField>
                        <a href="#" class="hlinkPopup" popup="selectFee"><img
                            src="/img/arrowRight.gif" /></a>
                        <div id="selectFee" class="contextualActionContent"
                            style="display: none">
                            <apex:pageBlock mode="maindetail">
                                <apex:inlineEditSupport disabled="true" />
                                <apex:pageblockTable var="c" value="{!loanAccount.Charges__r}">
                                    <apex:column headerValue="Charge" value="{!c.Name}" />
                                    <apex:column headerValue="Date" value="{!c.loan__Date__c}" />
                                    <apex:column headerValue="Type"
                                        value="{!c.Fee__r.loan__Time_of_charge__c}" />
                                    <apex:column headerValue="Total Due Amount"
                                        value="{!c.loan__Total_Amount_Due__c}" />
                                </apex:pageblockTable>
                            </apex:pageBlock>
                        </div>
                    </apex:outputPanel>
                </apex:pageblockSectionItem>
                <apex:outputField value="{!loan__Loan_Payment_Transaction__c.loan__Fees__c}"
                    rendered="!AND(Loan_Payment_Transaction__c.Manual_Payment__c, OR(NOT(Loan_Payment_Transaction__c.Manual_Payment__c),
                                                  OR(Loan_Payment_Transaction__c.Cleared__c, Loan_Payment_Transaction__c.Rejected__c)))}" />
                <apex:outputField value="{!loan__Loan_Payment_Transaction__c.loan__Excess__c}"
                    rendered="{!OR(loan__Loan_Payment_Transaction__c.loan__Cleared__c, loan__Loan_Payment_Transaction__c.loan__Rejected__c)}" />
                <apex:inputField value="{!loan__Loan_Payment_Transaction__c.loan__Transaction_Amount__c}"
                    required="true"
                    rendered="{!NOT(OR(OR(loan__Loan_Payment_Transaction__c.loan__Cleared__c, loan__Loan_Payment_Transaction__c.loan__Rejected__c), excessSelected))}" />
                <apex:outputField value="{!loan__Loan_Payment_Transaction__c.loan__Transaction_Amount__c}"
                    rendered="{!OR(OR(loan__Loan_Payment_Transaction__c.loan__Cleared__c, loan__Loan_Payment_Transaction__c.loan__Rejected__c), excessSelected)}" />
                <apex:inputField value="{!loan__Loan_Payment_Transaction__c.loan__Loan_Payment_Spread__c}" 
                    rendered="{!NOT(OR(Loan_Payment_Transaction__c.Cleared__c, 
                                        Loan_Payment_Transaction__c.Rejected__c, 
                                        Loan_Payment_Transaction__c.Manual_Payment__c)) && newSpreadEnabled}"/>       
                    
                <!--<apex:outputField value="{!Loan_Payment_Transaction__c.Loan_Snapshot__c}"/>
                  <apex:outputField value="{!Loan_Payment_Transaction__c.Fee_Snapshot__c}"/>
                  <apex:outputField value="{!Loan_Payment_Transaction__c.Dues_Snapshot__c}"/>-->
            </apex:pageBlockSection>
            <apex:pageBlockSection title="ACH" columns="1" id="achId">
                <apex:outputField value="{!loan__Loan_Payment_Transaction__c.loan__Sent_to_ACH__c}"/>
                <apex:outputField value="{!loan__Loan_Payment_Transaction__c.loan__Sent_To_ACH_On__c}"/>
                <apex:outputField value="{!loan__Loan_Payment_Transaction__c.loan__ACH_Filename__c}"/>
            </apex:pageBlockSection>
            </apex:outputpanel>
            <c:FieldSetPanel value2="Loan_Payment_Transaction__c" 
                                value3="{!loanPayment}"/>
        </apex:pageBlock>
    </apex:form>
    <apex:relatedList list="Repayment_Transaction_Adjustment__r"
        rendered="{!OR(loan__Loan_Payment_Transaction__c.loan__Cleared__c, loan__Loan_Payment_Transaction__c.loan__Reversed__c)}" />
    <apex:relatedList list="Fee_Payment__r"
        rendered="{!OR(loan__Loan_Payment_Transaction__c.loan__Cleared__c, loan__Loan_Payment_Transaction__c.loan__Reversed__c)}" />
    <apex:relatedList list="ProcessSteps" />
</apex:page>