<apex:page lightningStylesheets="true" standardController="loan__Loan_Account__c" extensions="loan.AutomatedPaymentSetupController" sidebar="{!IF($CurrentPage.Parameters.modal == 'true', false, true)}">
<apex:include pageName="clcommon__mintTheme"/>

  <apex:stylesheet value="{!IF($CurrentPage.Parameters.modal == 'true', $Resource.loan__modalheaderStyle,'')}" />
  <apex:stylesheet value="{!$Resource.loan__HelpLink_CSS}" />
  <script type= "text/javascript" src="{!$Resource.ShowPage_JS}"/>
    <script>
        function confirmCancel() {
            var isConfirm = confirm("Are you sure you want to cancel?");
            if(isConfirm){
                return this.parent.parent.window.close();
            }
        }

        function cancelOTACH(){
           var data = '{"source" : "OTACH", "message" : "cancel"}';
           window.parent.postMessage(data, '*');
        }
    </script>
  <apex:sectionHeader title="Automated payment setup against the loan: {!loan__Loan_Account__c.Name}" />
  
  <apex:form >
      <apex:commandLink value="Help On Automated Payment" id="thelink" onclick="popWindow('AutoPaymentConfig');" 
                        reRender="dummy" style="text-decoration:none;color:green;padding:1px" styleClass="link-show"
                        rendered="{!NOT($Setup.clcommon__CL_Platform_Settings__c.clcommon__Theme_Name__c == 'Mint')}"/>
      
      <apex:commandLink value="Help On Automated Payment" id="thelink2" onclick="popWindow('AutoPaymentConfig');" 
        reRender="dummy" styleClass="help-link" 
        rendered="{!$Setup.clcommon__CL_Platform_Settings__c.clcommon__Theme_Name__c == 'Mint'}"/>                      
      <br/><br/>
  <apex:pageBlock title="Setup Automated Payment" id="pb" mode="edit">
  <apex:pageMessages />
  <apex:pageBlockButtons location="both">
        <c:BusyButton name="Save" busyName="Saving"
            actionTo="{!saveSetup}" id="sBtn" reRenderTo="pb"
            oncomplete="({!closeModal}===true) ? closeIframe('{!loan__Loan_Account__c.Id}') : {};"
            style="margin-left:120px;" disabled="{!setup.Id != null}"/>
        <apex:commandButton value="Cancel" immediate="true"
            action="{!URLFOR($Action.Loan_Account__c.View,Loan_Account__c.Id)}"
            onclick="cancelOTACH(); closeIframe()"/>
  </apex:pageBlockButtons>
  <apex:pageBlockSection title="General Information">
    <apex:outputField id="LoanId" value="{!setup.loan__CL_Contract__c}" />
    <apex:outputField value="{!setup.loan__Active__c}"/>
    <apex:outputField value="{!setup.loan__Setup_Date__c}" />
    <apex:pageBlockSectionItem >
        <apex:outputLabel value="{!$ObjectType.loan__Automated_Payment_Setup__c.fields.loan__Type__c.label}" />
        <apex:actionRegion >
            <apex:inputField value="{!setup.loan__Type__c}" required="true">
              <apex:actionSupport event="onchange" reRender="pb" />
            </apex:inputField>
        </apex:actionRegion>
    </apex:pageBlockSectionItem>
    
    <apex:pageBlockSectionItem rendered="{!setup.loan__Type__c == 'RECURRING'}">
	    <apex:outputLabel value="Amount Type" />
	    <apex:actionRegion >
		    <apex:inputField value="{!setup.loan__Amount_Type__c}" required="true" >
		        <apex:actionSupport event="onchange" reRender="pb" />
		    </apex:inputField>
	    </apex:actionRegion>
    </apex:pageBlockSectionItem>
    
    <apex:pageBlockSectionItem >
	    <apex:outputLabel value="Bank Account" />
	    <apex:inputField value="{!setup.loan__Bank_Account__c}" required="true"/>
    </apex:pageBlockSectionItem>
    
    <apex:pageBlockSectionItem >
	    <apex:outputLabel value="Payment Mode" />
	    <apex:inputField value="{!setup.loan__Payment_Mode__c}" required="true">
	        <apex:actionSupport event="onchange" id="pmChange" reRender="retryDetails" action="{!getRetryDetails}"/>
	    </apex:inputField>
    </apex:pageBlockSectionItem>
    
    <apex:pageBlockSectionItem rendered="{!IF(OR(setup.loan__Type__c=='ONE TIME',setup.loan__Amount_Type__c=='FIXED AMOUNT'),true,false)}">
	    <apex:outputLabel value="Transaction Amount" />
	    <apex:inputField value="{!setup.loan__Transaction_Amount__c}" required="true"/>
    </apex:pageBlockSectionItem>
    
    <apex:pageBlockSectionItem >
	    <apex:outputLabel value="Debit Date" />
	    <apex:inputField value="{!setup.loan__Debit_Date__c}" required="true"/>
    </apex:pageBlockSectionItem>
    
    <apex:pageBlockSectionItem >
	    <apex:outputLabel value="Installment Payment" rendered="{!loan__Loan_Account__c.loan__Product_Type__c == 'Flexible Amz Loan'}"/>
	    <apex:inputField value="{!setup.loan__Installment_Payment__c}" 
	    rendered="{!loan__Loan_Account__c.loan__Product_Type__c == 'Flexible Amz Loan'}"/>
    </apex:pageBlockSectionItem>
    
    <apex:pageBlockSectionItem rendered="{!setup.loan__Type__c == 'RECURRING'}">
	    <apex:outputLabel value="Recurring ACH Start Date" />
	    <apex:outputPanel layout="block" id="pwPanel">
    	<apex:inputField value="{!setup.loan__Recurring_ACH_Start_Date__c}" required="true"/>
    	</apex:outputPanel>
    </apex:pageBlockSectionItem>
    <apex:pageBlockSectionItem rendered="{!setup.loan__Type__c == 'RECURRING'}">
	    <apex:outputLabel value="Recurring ACH End Date" />
	    <apex:outputPanel layout="block" id="pwPanel1">
	    	<apex:inputField value="{!setup.loan__Recurring_ACH_End_Date__c}" required="false"/>
	    </apex:outputPanel>
    </apex:pageBlockSectionItem>
    <apex:pageBlockSectionItem rendered="{!setup.loan__Type__c == 'RECURRING'}" >
	    <apex:outputLabel value="Frequency" />
	    <apex:inputField value="{!setup.loan__Frequency__c}" required="true" >
	        <apex:actionSupport event="onchange" reRender="pb" action="{!setDebitDateForBillingFrequency}"/>
	    </apex:inputField>
    </apex:pageBlockSectionItem>
    <apex:pageBlockSectionItem rendered="{!IF(OR(setup.loan__Frequency__c=='Monthly',setup.loan__Frequency__c=='Weekly',setup.loan__Frequency__c=='Daily'),true,false)}">
	    <apex:outputLabel value="Frequency Cycle" />
	    <apex:inputField value="{!setup.loan__Frequency_Cycle__c}"/>
    </apex:pageBlockSectionItem>
    <apex:pageBlockSectionItem rendered="{!setup.loan__Type__c == 'ONE TIME' && newSpreadEnabled}">
	    <apex:outputLabel value="Payment Spread" />
	    <apex:inputField value="{!setup.loan__Loan_Payment_Spread__c}"/>
    </apex:pageBlockSectionItem>
    </apex:pageBlockSection>

    <apex:pageBlockSection id="retryDetails" title="Retry Details">
        <apex:inputField value="{!setup.loan__Retry__c}"/>
        <apex:inputField value="{!setup.loan__Return_Codes_for_Retry__c}"/>
        <apex:inputField value="{!setup.loan__Number_of_Retry_Attempts__c}"/>
        <apex:inputField value="{!setup.loan__Retry_Attempt_Interval__c}"/>
        <apex:inputField value="{!setup.loan__Apply_NSF_on_Attempt__c}"/>        
    </apex:pageBlockSection>
</apex:pageBlock>
</apex:form>
</apex:page>