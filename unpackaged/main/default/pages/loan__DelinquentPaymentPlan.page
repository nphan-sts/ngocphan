<apex:page lightningStylesheets="true" standardController="loan__Loan_Account__c"
    extensions="loan.LoanDlqPmtPlanController"
    sidebar="{!IF($CurrentPage.Parameters.modal == 'true', false, true)}">
<apex:include pageName="clcommon__mintTheme"/>

    <apex:stylesheet value="{!$Resource.loan__MFIStyles}" />
    <apex:stylesheet value="{!$Resource.loan__HelpLink_CSS}" />
    <script type= "text/javascript" src="{!$Resource.ShowPage_JS}"/>
    <apex:stylesheet value="{!IF($CurrentPage.Parameters.modal == 'true', $Resource.loan__modalheaderStyle,'')}" />
    <script
        src="{!URLFOR($Resource.jQueryFiles, 'js/jquery-1.8.3.min.js')}" />
    <script src="{!URLFOR($Resource.helperclose)}" type="text/javascript" />
    <script>
        j$ = jQuery.noConflict();

    </script>
    <script>
        function setFocusOnLoad() {}

        function confirmCancel() {
            var isConfirm = confirm("Are you sure you want to cancel?");
            if(isConfirm){
                return this.parent.parent.window.close();
            }
        }
        function showLoadingDiv() {
          j$("[id$=loading-curtain-div]").append( "<h1><center>Refreshing...Please wait.</center></h1>" );
        }

        function changePreview()
        {
            showLoadingDiv();
            CallApexMethod() ;
        }

        function showConfirmation() {
            var extendMaturity=  j$('[id *= ExtendMaturityFlag]').is(':checked');
            var term= j$('[id *= term]').val();

            var isConfirm = false;
            if (extendMaturity){
                if (term ==1){
                    isConfirm = confirm('Are you sure you want to extend the maturity date by 1 month with a lump sum due on Maturity Date?');

                }else if (term >1){
                    isConfirm = confirm('Are you sure you want to extend customers maturity date by '+term +' months?');

                }
            }else if (!extendMaturity){
                isConfirm = confirm('Are you sure you want to increase the customers monthly payments?');

            }
            if(isConfirm){
                showLoadingDiv();
                CallSave();
            }else{
                location.reload(true);
            }
        }
    </script>

    <apex:sectionHeader title="Delinquency Payment Plan: {!loan__Loan_Account__c.Name}" />
    <apex:outputPanel >
        <apex:form id="delinquentForm">
            <apex:commandLink value="Help On Payment Plan" id="thelink" onclick="popWindow('Payment Plan');"
                              reRender="dummy" style="text-decoration:none;color:green;padding:1px" styleClass="link-show"
                              rendered="{!NOT($Setup.clcommon__CL_Platform_Settings__c.clcommon__Theme_Name__c == 'Mint')}"/>
            <apex:commandLink value="Help On Payment Plan" id="thelink2" onclick="popWindow('Payment Plan');"
                                reRender="dummy" styleClass="help-link"
                                rendered="{!$Setup.clcommon__CL_Platform_Settings__c.clcommon__Theme_Name__c == 'Mint'}"/>

            <br/><br/>

            <apex:actionFunction name="CallApexMethod" action="{!changePreview}" />
            <apex:actionFunction name="CallSave" action="{!DlqPmtPlanLoan}" oncomplete="({!closeModal}==true) ? closeIframe('{!loan__Loan_Account__c.Id}') : {};" reRender="delinquentForm"/>
            <apex:outputPanel id="loading-curtain-div"/>
            <apex:pageBlock id="DlqPmtPlanPBId" mode="edit">
                <apex:pageMessages />
                <apex:pageBlockButtons location="both">
                    <c:BusyButton name="Preview" busyname="Generating Preview..."
                        actionTo="{!preview}" style="margin-left:80px;"
                        reRenderTo="DlqPmtPlanPBId,DlqPmtPlanLoanPanel,loanAmzschedulePanelPageBlockSection" />
                    <c:BusyButton name="Save" busyName="Saving"
                        onclick="return showConfirmation();"  rerenderTo="delinquentForm"
                        oncomplete="({!closeModal}==true) ? closeIframe('{!loan__Loan_Account__c.Id}') : {};" />
                    <c:BusyButton name="Reset" busyName="Resetting" actionTo="{!reset}"
                        reRenderTo="DlqPmtPlanLoanPanel" />
                    <apex:commandButton value="Cancel" immediate="true"
                        action="{!URLFOR($Action.Loan_Account__c.View,Loan_Account__c.Id)}"
                        onclick="closeIframe()" />
                </apex:pageBlockButtons>
                <apex:outputpanel id="DlqPmtPlanLoanPanel">
                	<apex:outputPanel styleClass="mint-lightning-wrapper mint-lightning-wrapper-center">
                    <apex:pageBlockSection columns="2"
                        id="loanInfoPanelPageBlockSection" title="Loan Information">
                        <apex:outputField value="{!loan__Loan_Account__c.loan__Delinquent_Amount__c}" />
                        <apex:outputField value="{!DlqPmtPlanTxn.loan__Txn_Date__c}" />
                        <apex:outputField label="Next Due Date"
                            value="{!DlqPmtPlanTxn.loan__Repayment_Start_Date__c}" />
                        <apex:outputField label="Current Maturity Date"
                            value="{!loanAccount.loan__Maturity_Date_Current__c}" />
                    </apex:pageBlockSection>
                    </apex:outputPanel>

                    <apex:pageBlockSection columns="1" id="RSSSection"
                        title="Current Repayment Schedule">
                        <apex:pageblockTable value="{!orgRssList}" id="rssTable"
                            var="RSS" headerClass="tableRight" styleClass="tableRight">
                            <apex:column value="{!RSS.loan__RSS_Seq__c}"
                                headerValue="Sequence Number" />
                            <apex:column value="{!RSS.loan__RSS_Repayment_Dt__c}"
                                headerValue="Repayment Start Date" headerClass="tableLeft"
                                styleClass="tableLeft" />
                            <apex:column value="{!RSS.loan__RSS_No_Of_Pmts__c}"
                                headerValue="Number of Payments" />
                            <apex:column value="{!RSS.loan__RSS_Repayment_Amt__c}"
                                headerClass="Repayment Amount" />
                        </apex:pageblockTable>
                    </apex:pageBlockSection>

                    <apex:outputPanel styleClass="mint-lightning-wrapper mint-lightning-wrapper-center">
                    <apex:pageBlockSection columns="2"
                        id="inputInfoPanelPageBlockSection" title="Parameters">
                        <apex:inputField id="ExtendMaturityFlag"
                            value="{!DlqPmtPlanTxn.loan__Extend_Maturity_Date__c}"
                            OnChange="changePreview();" />
                        <apex:inputField id="term" label="Spread Over Terms"
                            value="{!DlqPmtPlanTxn.loan__Number_of_Installments__c}"
                            required="true" OnChange="changePreview();" />
                    </apex:pageBlockSection>
                    </apex:outputPanel>

                    <apex:pageBlockSection columns="2"
                        id="loanAmzschedulePanelPageBlockSection" title="Results "
                        rendered="{!(isPreview==True)}">
                        <apex:pageBlockSection columns="1" id="summarySection"
                            title="Summary">
                            <!--<apex:outputText label="New Maturity Date" value="{!DlqPmtPlanTxn.OT_Maturity_Date__c }"/>-->
                            <apex:outputText label="New Maturity Date"
                                value="{0,date,MM'/'dd'/'yyyy}">
                                <apex:param value="{!DlqPmtPlanTxn.OT_Maturity_Date__c }" />
                            </apex:outputText>
                        </apex:pageBlockSection>
                        <apex:pageBlockSection columns="1" id="RSSSectionChanged"
                            title="Repayment Schedule">
                            <apex:pageblockTable value="{!rssRecsList}" id="rssTable"
                                var="RSS">
                                <apex:column value="{!RSS.loan__RSS_Seq__c}"
                                    headerValue="Sequence Number" />
                                <apex:column value="{!RSS.loan__RSS_Repayment_Dt__c}"
                                    headerValue="Repayment Start Date" headerClass="tableLeft"
                                    styleClass="tableLeft" />
                                <apex:column value="{!RSS.loan__RSS_Repayment_Amt__c}"
                                    headerClass="Repayment Amount" />
                                <apex:column value="{!RSS.loan__RSS_No_Of_Pmts__c}"
                                    headerValue="Number of Payments" />
                            </apex:pageblockTable>
                        </apex:pageBlockSection>
                    </apex:pageBlockSection>
                </apex:outputpanel>
            </apex:pageBlock>
        </apex:form>
    </apex:outputPanel>
</apex:page>