<apex:page lightningStylesheets="true" standardController="loan__Loan_Account__c" extensions="loan.AmortizationScheduleCalculator" sidebar="{!IF($CurrentPage.Parameters.modal == 'true', false, true)}"  renderAs="{!renderAsValue}"  >
<apex:include pageName="clcommon__mintTheme"/>

        <apex:stylesheet value="{!IF($CurrentPage.Parameters.modal == 'true', $Resource.loan__modalheaderStyle,'')}"/>
        <apex:stylesheet value="{!$Resource.loan__MFIStyles}"/>
        <apex:stylesheet value="{!$Resource.loan__StatementStyleSheet}"/>
        <script src="{!URLFOR($Resource.jQueryFiles, 'js/jquery-1.8.3.min.js')}"/>
        <script src="{!URLFOR($Resource.helperclose)}"/>
        <script>
        j$ = jQuery.noConflict();
        </script>
        <script>
        function confirmCancel() {
            var isConfirm = confirm("Are you sure you want to cancel?");
            if(isConfirm){
            return this.parent.parent.window.close();
            }
        }

        </script>
        <script type="text/javascript"
        src="{!URLFOR($Resource.jQueryFiles, 'js/jquery-1.8.3.min.js')}" />

        <script>
        function testify(){
            alert(j$('').length);
        };
          function scrolify(tblAsJQueryObject, height){
        var oTbl = tblAsJQueryObject;

        // for very large tables you can remove the four lines below
        // and wrap the table with <div> in the mark-up and assign
        // height and overflow property  
        var oTblDiv = $("<div/>");
        oTblDiv.css('height', height);
        oTblDiv.css('overflow-y','scroll');
        oTbl.wrap(oTblDiv);

        // save original width
        oTbl.attr("data-item-original-width", oTbl.width());
        oTbl.find('thead tr td').each(function(){
            $(this).attr("data-item-original-width",$(this).width());
        }); 
        oTbl.find('tbody tr:eq(0) td').each(function(){
            $(this).attr("data-item-original-width",$(this).width());
        });                 


        // clone the original table
        var newTbl = oTbl.clone();

        // remove table header from original table
        oTbl.find('thead tr').remove();                 
        // remove table body from new table
        newTbl.find('tbody tr').remove();   

        oTbl.parent().parent().prepend(newTbl);
        newTbl.wrap("<div/>");

        // replace ORIGINAL COLUMN width                
        newTbl.width(newTbl.attr('data-item-original-width'));
        newTbl.find('thead tr td').each(function(){
            $(this).width($(this).attr("data-item-original-width"));
        });     
        oTbl.width(oTbl.attr('data-item-original-width'));      
        oTbl.find('tbody tr:eq(0) td').each(function(){
            $(this).width($(this).attr("data-item-original-width"));
        });                 
        }

        function callScroll() {
        scrolify($('.scrollableFixedHeader'), 300); // 160 is height
        }
        </script>
        <style>
        .mfiflex-namevaluetable{
            margin-left:auto;
            margin-right:auto;
            width:80%;
        }
        .rightalign {
            text-align:right;
        }
        </style>


      <apex:sectionHeader title="Amortization Schedule Calculator: {!loan__Loan_Account__c.Name}" />
      <apex:outputPanel >   
          <apex:form id="calculatorForm">
          <apex:pageBlock id="amzSchGenPBId" mode="detail">           
               <apex:pageMessages />
               <apex:pageBlockButtons location="both">
	               <c:BusyButton name="Preview" busyname="Generating Preview..." actionTo="{!preview}" 
	               oncomplete="callScroll()" style="margin-left:100px;" 
	               reRenderTo="amzSchGenPBId,amzSchGenLoanPanel,loanAmzschedulePanelPageBlockSection"/>
	               <!--  <c:BusyButton name="Print" busyName="Saving" actionTo="{!printamzSchGenLoan}" 
	               oncomplete="({!closeModal}===true) ? closeIframe('{!Loan_Account__c.Id}') : {};" 
	               reRenderTo="calculatorForm" />
	               -->
	               <apex:commandButton value="PDF for Print" action="{!saveAsPdf}" rendered="{!IF(renderAsValue == 'pdf',false,true)}"/>
	               <c:BusyButton name="Reset" busyName="Resetting" actionTo="{!reset}" reRenderTo="amzSchGenLoanPanel"/>
	               <apex:commandButton value="Cancel" immediate="true" action="{!URLFOR($Action.Loan_Account__c.View,Loan_Account__c.Id)}" onclick="closeIframe()"/>               
	            </apex:pageBlockButtons>
            <apex:outputpanel id="amzSchGenLoanPanel">
            <apex:actionStatus id="generatePreview" startText="Generating preview..."/>
            <table class="mfiflex-namevaluetable" summary="Loan Details" >
              <tbody>
                      <tr>
                            <td width="25%"><b>Customer Name</b>&emsp;</td>
                            <td width="25%">{!custName}</td>
                            <td width="25%"><b>Loan Account</b>&emsp;</td>
                            <td width="25%">{!loanAccount.Name}</td>
                      </tr>
                      <tr>
                            <td><b>Loan Amount</b>&emsp;</td>
                            <td>{!loanAccount.Loan_Amount__c}</td>
                            <td><b>Loan Product</b>&emsp;</td>
                            <td>{!loanAccount.Loan_Product_Name__r.Name}</td>
                      </tr>
                      <tr>
                            <td><b>Interest Rate</b>&emsp;</td>
                            <td>{!loanAccount.loan__Interest_Rate__c}</td>
                            <td><b>Term</b>&emsp;</td>
                            <td>{!loanAccount.Number_of_Installments__c}</td>
                      </tr>
                      <tr>
                            <td><b>Billing Method</b>&emsp;</td>
                            <td>{!loanAccount.Interest_Calculation_Method__c}</td>
                            <td><b>Time Counting Method</b>&emsp;</td>
                            <td>{!loanAccount.loan__Time_Counting_Method__c}</td>
                      </tr>
                      <tr>
                            <td><b>Principal Remaining</b>&emsp;</td>
                            <td>{!principalRemaining}</td>
                            <td><b>Total Interest Due</b>&emsp;</td>
                            <td>{!TotalInterestDue}</td>
                      </tr>
                      <tr>
                            <td><b>Payment Amount</b>&emsp;</td>
                            <td>{!paymentAmount}</td>
                            <td><b>Transaction Date</b>&emsp;</td>
                            <td>{!txnDate}</td>
                      </tr>
                      <tr>
                            <td><b>Next Payment Date</b>&emsp;</td>
                            <td>{!repStartDate}</td>
                            <td><b><apex:outputText value="Total Interest Amount" rendered="{!((isPreview==True))}"/></b></td>
                            <td><apex:outputText value="{!calc.loan__Interest_Amt__c}"  rendered="{!((isPreview==True))}"/></td>
                      </tr>
              </tbody>
              </table>
            
            <apex:outputPanel styleClass="mint-lightning-wrapper mint-lightning-wrapper-center"> 
            <apex:pageBlockSection columns="2" id="paymentsummarySection" title="What if.." rendered="{!IF(renderAsValue == 'pdf',false,true)}">
               <apex:inputfield value="{!loanAccount.loan__Interest_Rate__c}"/>
               <apex:inputfield value="{!loanAccount.loan__Frequency_of_Loan_Payment__c}"/>
               <apex:inputfield value="{!loanAccount.loan__Term_Cur__c}"/>
               <apex:inputfield value="{!loanAccount.loan__Interest_Only_Period__c}"/>
               <apex:inputfield value="{!loanAccount.loan__Time_Counting_Method__c}"/>
               <apex:inputfield value="{!loanAccount.loan__Balloon_Payment__c}"/>               
               <apex:inputCheckbox value="{!simulatePayment}" label="Simulate a Payment">
                    <apex:actionSupport action="{!simulatePayment}" rerender="paymentSimulationSection,amzSchGenLoanPanel" event="onchange"/>
                </apex:inputCheckbox>
            </apex:pageBlockSection>
            </apex:outputPanel>
           
           	<apex:pageBlockSection columns="1" id="paymentSimulationSection" title="Simulate Payment" rendered="{!simulatePayment}">
          		<apex:pageBlock >
           			<apex:pageBlockSection title="Payment Transaction" columns="2">
		           		<apex:inputfield value="{!payment.loan__Transaction_Amount__c}"/>
		               	<apex:outputfield value="{!payment.loan__Transaction_Date__c}"/>
		               	<apex:outputfield value="{!payment.loan__Interest__c}"/>
		               	<apex:outputfield value="{!payment.loan__Fees__c}"/>
		               	<apex:outputfield value="{!payment.loan__Principal__c}"/>
		               	<apex:outputfield value="{!payment.loan__Excess__c}"/>
	               	</apex:pageBlockSection>
	               	<apex:pageBlockButtons id="blkButtons" location="bottom">
		               	<c:BusyButton name="Simulate a Payment" busyname="Simulating..." actionTo="{!simulatePayment}" 
		               		style="margin-left:100px;" reRenderTo="paymentSimulationSection,amzSchGenLoanPanel"/>
               		</apex:pageBlockButtons>
             	</apex:pageBlock>            	
           	</apex:pageBlockSection>
           	
            <apex:pageBlockSection columns="1" id="loanAmzschedulePanelPageBlockSection" title="Repayment Schedule" rendered="{!(isPreview==True)}"  >
               <apex:pageBlockSection columns="1" id="RSSSection">
                  <apex:pageblockTable value="{!rssRecsList}" id="rssTable" var="RSS">
                  <apex:column value="{!RSS.loan__RSS_Seq__c}" headerValue="Sequence Number" styleClass="rightalign" headerClass="rightalign" />
                  <apex:column value="{!RSS.loan__RSS_Repayment_Dt__c}" headerValue="Repayment Start Date" />
                  <apex:column value="{!RSS.loan__RSS_Repayment_Amt__c}" headerValue="Repayment Amount" styleClass="rightalign" headerClass="rightalign" />
                  <apex:column value="{!RSS.loan__RSS_No_Of_Pmts__c}" headerValue="Number Of Payments" styleClass="rightalign" headerClass="rightalign" />
                  </apex:pageblockTable>                  
              </apex:pageBlockSection>
              <apex:pageBlockSection columns="1" id="RSSection" title="Amortization Schedule" >
                <apex:outputPanel layout="block" style="overflow:auto;height:auto;" rendered="{!(isCheck==false)}">
                  <apex:pageblockTable value="{!emiList}" id="amzSch" var="EMI">                             
                      <apex:column value="{!EMI.paymentNo}" headerValue="Sequence Number"  width="10%" styleClass="rightalign" headerClass="rightalign"/>  
                      <apex:column value="{!EMI.dueDateString}" headerValue="Due Date"  width="18%" />
                      <apex:column value="{!EMI.amount}" headerValue="Amount" width="18%" styleClass="rightalign" headerClass="rightalign"/>
                      <apex:column value="{!EMI.fee1}" headerValue="Fee" width="18%" styleClass="rightalign" headerClass="rightalign"/>
                      <apex:column value="{!EMI.interest}" headerValue="Interest" width="18%" styleClass="rightalign" headerClass="rightalign"/>
                      <apex:column value="{!EMI.principal}" headerValue="Principal" width="18%" styleClass="rightalign" headerClass="rightalign"/>
                      <apex:column value="{!EMI.balance}" headerValue="Balance" width="18%" styleClass="rightalign" headerClass="rightalign" /> 
                  </apex:pageblockTable>
                </apex:outputPanel>
                <apex:outputPanel layout="block" style="overflow:auto;height:auto;" rendered="{!(isCheck==true)}">
                  <apex:pageBlockTable value="{!origemiList}" id="origemiTable" var="EMI">                             
                      <apex:column value="{!EMI.paymentNo}" headerValue="Sequence Number" width="10%" styleClass="rightalign" headerClass="rightalign" />                                       
                      <apex:column value="{!EMI.dueDateString}" headerValue="Due Date" width="18%" />
                      <apex:column value="{!EMI.amount}" headerValue="Amount" width="18%" styleClass="rightalign" headerClass="rightalign"/> 
                      <apex:column value="{!EMI.principal}" headerValue="Principal" width="18%" styleClass="rightalign" headerClass="rightalign" />
                      <apex:column value="{!EMI.interest}" headerValue="Interest" width="18%" styleClass="rightalign" headerClass="rightalign" />
                      <apex:column value="{!EMI.fee1}" headerValue="Fee" width="18%" styleClass="rightalign" headerClass="rightalign"/>
                      <apex:column value="{!EMI.balance}" headerValue="Balance" width="18%" styleClass="rightalign" headerClass="rightalign"/> 
                      <div style="page-break-after:always;"/>
                  </apex:pageblockTable>
                </apex:outputPanel>
             </apex:pageBlockSection>   
            </apex:pageBlockSection>                
            </apex:outputpanel>               
          </apex:pageBlock>
          </apex:form>
      </apex:outputPanel>
    </apex:page>